# 预处理故障排查指南

## 常见失败原因

预处理时可能会遇到书籍处理失败的情况，输出会显示：

```
[7/25] ✗ 失败: 《1908大军阀》（详见上方错误信息）
```

### 失败类型1：未找到 .txt 文件

**错误信息**：
```
❌ 失败: 未在 xxx.rar 中找到可用的 .txt 文件
   原因: RAR文件可能损坏或不包含.txt文件
```

**可能原因**：
1. RAR 文件损坏或加密
2. RAR 文件中不包含 .txt 文件（可能是其他格式如 .doc、.pdf）
3. RAR 文件为空

**解决方法**：
1. 手动解压 RAR 文件检查内容
2. 重新下载书籍文件
3. 如果是其他格式，需要先转换为 .txt

### 失败类型2：未检测到章节（已自动处理）

**警告信息**（不再导致失败）：
```
⚠️  《书名》未检测到标准章节标题
   启用保底规则: 按 2000 行自动切分
   文件信息: 3495884 字符，76286 行
   已生成 39 个自动章节
✓ 完成《书名》，共 39 章。
```

**说明**：
- 系统检测不到标准章节标题时，会**自动启用保底规则**
- 按 **2000 行/章** 自动切分，生成章节
- 章节标题格式：`第1章 第1-2000行`、`第2章 第2001-4000行`...
- **不会导致处理失败**，所有书籍都能成功输出

**触发保底规则的情况**：
1. **章节标题格式不标准**
   - 系统支持的格式：`第一章`、`第1章`、`Chapter 1`、`第一卷` 等
   - 不支持的格式：`001.`、`==第一章==`、纯数字章节等

2. **整本书没有章节分隔**
   - 某些书籍没有明确的章节标题
   - 全书一个段落

**真正会失败的情况**（极少）：
```
❌ 失败: 《书名》内容过少（仅5行）
   文本预览: ...
```
- 只有文件**少于10行**时才会真正失败
- 这通常表示文件损坏或内容无效

**是否需要手动处理？**

大多数情况下，**不需要**！保底规则已经自动处理了。

但如果你想要正确的章节标题（而不是"第X章 第X-Y行"），可以：

#### 可选：手动检查文件格式
```bash
# 解压文件查看内容
cd sourceRar
unrar x "《书名》.rar"
# 查看txt文件的前几行
head -50 *.txt
```

#### 可选：查看支持的章节格式
系统识别以下格式的章节标题：

**中文格式**：
- `第一章 标题`、`第1章 标题`
- `第一节`、`第1节`
- `第一回`、`第1回`
- `卷一`、`第一卷`
- `楔子`、`序章`、`引子`、`尾声`、`后记`、`番外`

**英文格式**：
- `Chapter 1`、`Chapter One`
- `Episode 1`、`Ep. 1`
- `Act 1`、`Scene 1`

#### 可选：修改书籍文件（如果你想要原始章节标题）
如果你想要原始的章节标题而不是自动生成的：
1. 手动编辑 txt 文件，统一章节标题格式
2. 使用文本替换工具批量修改格式
   ```
   例如将: 001. 章节名
   替换为: 第1章 章节名
   ```
3. 重新运行预处理（删除 manifest.json 强制重新处理）

## 批次统计说明

每批处理完会显示统计信息：

```
========================================
本批完成: ✓ 成功 25 本
还有 7656 本待处理，外部循环将自动继续...
========================================
```

或者如果有失败（非常罕见）：

```
========================================
本批完成: ✓ 成功 24 本，✗ 失败 1 本
注意: 失败的书籍已跳过，不会重复处理
还有 7656 本待处理，外部循环将自动继续...
========================================
```

**说明**：
- `✓ 成功 X 本`：成功处理并生成章节信息的书籍数（包括使用保底规则的）
- `✗ 失败 X 本`：真正失败的书籍数（通常是文件损坏或内容过少）
- 失败的书籍会被标记为"已处理"，避免下次重复尝试
- 使用保底规则的书籍会有 `⚠️` 警告标记，但**算作成功**

## 查看失败书籍列表

如果想查看哪些书籍处理失败了，可以对比：

1. **原始文件列表**：
   ```bash
   ls sourceRar/*.rar | wc -l
   ```

2. **成功处理的书籍数**：
   查看 `public/data/books.json` 中的 books 数量

3. **找出失败的书籍**：
   - 失败的书籍在 manifest 中不会有记录
   - 也不会生成对应的 `${bookId}_chapters.json` 文件

## 重新处理失败的书籍

如果修复了某本书的问题，想重新处理：

1. **删除该书的缓存**：
   ```bash
   # 从 manifest 中删除该书的记录（如果有）
   # 或直接删除整个 manifest
   rm generated/manifest.json
   rm generated/pending_books.json
   ```

2. **重新运行预处理**：
   ```bash
   npm run preprocess
   ```
   
   系统会重新扫描，发现该书已修复后会重新处理

## 预防措施

1. **使用统一的书籍来源**
   - 从相同网站/渠道下载的书籍格式通常一致
   - 成功率会更高

2. **检查文件完整性**
   - 下载后检查文件大小是否合理
   - 确保文件没有损坏

3. **批量处理前先测试**
   - 先放几本书测试处理效果
   - 确认成功后再批量处理

## 技术细节

### 章节识别规则

系统使用复杂的模式匹配识别章节标题：

1. **基础模式**：
   - 中文数字：一、二、三...十、百、千
   - 阿拉伯数字：1, 2, 3...
   - 罗马数字：I, II, III, IV...

2. **标记词**：
   - 主标记：章、节、回、集、篇、幕、话、段、折、品
   - 上级标记：卷、部、册、季

3. **置信度评分**：
   - 系统会对每个潜在的章节标题进行评分
   - 只有得分超过阈值的才会被识别为章节
   - 评分考虑：长度、标点密度、格式规范性等

如果你的书籍格式特殊，可能需要调整识别规则（修改 `scripts/preprocess.ts` 中的 `parseChapterIndices` 函数）。
