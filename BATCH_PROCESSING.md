# 预处理快速指南

## ⭐ 全自动处理

所有预处理命令现在都是**全自动**的：
- ✅ **自动循环**：会自动处理所有书籍，无需手动多次运行
- ✅ **智能分批**：根据内存限制自动分批，防止内存溢出
- ✅ **自动停止**：处理完所有书籍后自动结束

## 快速开始

只需运行一次命令，等待完成即可！

### 场景1：我有很多书，担心内存不够

**最安全的方式**（推荐）：
```bash
npm run preprocess:low-memory
```
- ✅ 每批处理 **25本** 书
- ✅ 内存限制 **256MB**
- ✅ 自动循环直到完成
- ✅ 适合低配设备（2-4GB RAM）

### 场景2：正常使用（默认）

```bash
npm run preprocess
```
- ✅ 每批处理 **50本** 书
- ✅ 内存限制 **512MB**
- ✅ 自动循环直到完成
- ✅ 适合大多数情况（4-8GB RAM）

### 场景3：内存充足，想快点完成

```bash
npm run preprocess:high-memory
```
- ✅ 每批处理 **200本** 书
- ✅ 内存限制 **1GB**
- ✅ 自动循环直到完成
- ✅ 速度最快（>= 8GB RAM）

## 核心特性

✅ **全自动循环** - 一次运行，自动处理所有书籍  
✅ **智能分批** - 根据配置自动分批，防止内存溢出  
✅ **断点续传** - 可以随时中断（Ctrl+C），下次运行会继续  
✅ **内存监控** - 实时显示内存使用，自动GC  
✅ **智能跳过** - 已处理的书籍自动跳过  
✅ **自动检测** - 处理完成后自动停止，无需手动判断

## 示例输出

```
========================================
自动批处理模式
批次大小: 50 本/批
内存限制: 512MB
========================================

>>> 开始第 1 批处理 <<<

找到 250 本书
其中 0 本已是最新，250 本需要处理
本次将处理: 50 本

[1/50] 正在处理《书名1》...
[2/50] 正在处理《书名2》...
...
[50/50] 正在处理《书名50》...

📌 注意: 还有 200 本书待处理

⏳ 等待3秒后继续下一批...

>>> 开始第 2 批处理 <<<

找到 250 本书
其中 50 本已是最新，200 本需要处理
本次将处理: 50 本
...

>>> 开始第 5 批处理 <<<

找到 250 本书
其中 200 本已是最新，50 本需要处理
本次将处理: 50 本
...

✅ 所有书籍处理完成！

========================================
批处理完成！
共执行: 5 批
总耗时: 3分45秒
========================================
```

## 常见问题

### Q: 会自动处理所有书籍吗？
**A**: 是的！现在只需运行一次命令，脚本会自动循环直到处理完所有书籍。

### Q: 需要等多久？
**A**: 取决于书籍数量和大小：
- **小型书库**（< 50本，每本 < 5MB）：约5-10分钟
- **中型书库**（100-200本，每本10MB）：约20-40分钟
- **大型书库**（500+本）：可能需要1-2小时

处理速度参考：
- 1-5MB的书：约1-2秒/本
- 10-20MB的书：约3-5秒/本

### Q: 中途可以停止吗？
**A**: 可以！按 `Ctrl+C` 停止，已处理的书会保存。下次运行会自动跳过它们继续处理。

### Q: 怎么知道全部处理完了？
**A**: 当看到以下信息时：
```
✅ 所有书籍处理完成！
========================================
批处理完成！
```

### Q: 为什么要等待3秒？
**A**: 每批处理之间等待3秒，让系统完全释放内存和资源，确保稳定性。

## 推荐配置

| 你的情况 | 推荐命令 | 批次大小 | 内存限制 |
|---------|---------|---------|---------|
| 内存 < 4GB | `npm run preprocess:low-memory` | 25本 | 256MB |
| 内存 4-8GB | `npm run preprocess` | 50本 | 512MB |
| 内存 >= 8GB | `npm run preprocess:high-memory` | 200本 | 1GB |
| 书籍 < 50本 | `npm run preprocess` | 自动完成 | 512MB |
| 书籍 100-500本 | `npm run preprocess` | 自动完成 | 512MB |
| 书籍 > 500本 | `npm run preprocess:low-memory` | 自动完成 | 256MB |

**注意**：所有配置都是全自动的，会循环处理直到完成！

## 详细文档

查看 [PREPROCESS_MEMORY.md](./PREPROCESS_MEMORY.md) 了解：
- 内存监控详情
- 技术实现原理
- 完整故障排除指南
- 性能测试数据
